{% extends "base.html" %}

{% block title %}Manage Schedules - Admin{% endblock %}

{% block content %}
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
        <h2>Manage Schedules</h2>
        <a href="/admin" class="btn btn-secondary">← Back to Dashboard</a>
    </div>

    <!-- Add New Schedule Form -->
    <div style="background: #f5f5f5; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;">
        <h3 style="margin-bottom: 1rem;">Add New Schedule</h3>
        <form id="add-schedule-form">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                <div class="form-group">
                    <label for="train_id">Train</label>
                    <select id="train_id" name="train_id" required>
                        <option value="">Select a train...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="route_id">Route</label>
                    <select id="route_id" name="route_id" required>
                        <option value="">Select a route...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="departure_time">Departure Time</label>
                    <input type="time" id="departure_time" name="departure_time" required step="1">
                </div>
                <div class="form-group">
                    <label for="arrival_time">Arrival Time</label>
                    <input type="time" id="arrival_time" name="arrival_time" required step="1">
                </div>
                <div class="form-group">
                    <label for="frequency">Frequency</label>
                    <select id="frequency" name="frequency" required>
                        <option value="daily">Daily</option>
                        <option value="weekly">Weekly</option>
                        <option value="weekend">Weekend</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="base_fare">Base Fare (₴)</label>
                    <input type="number" id="base_fare" name="base_fare" required min="1" step="0.01" placeholder="e.g., 250">
                </div>
                <div class="form-group">
                    <label for="schedule_status">Status</label>
                    <select id="schedule_status" name="status">
                        <option value="active">Active</option>
                        <option value="cancelled">Cancelled</option>
                        <option value="delayed">Delayed</option>
                    </select>
                </div>
            </div>
            <button type="submit" class="btn btn-primary" style="margin-top: 1rem;">Add Schedule</button>
        </form>
    </div>

    <!-- Schedules Table -->
    <h3 style="margin-bottom: 1rem;">All Schedules</h3>
    <div id="schedules-container">
        <p style="text-align: center;">Loading schedules...</p>
    </div>
</div>

<!-- Edit Modal -->
<div id="edit-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="background: white; max-width: 500px; margin: 5% auto; padding: 2rem; border-radius: 8px; max-height: 80vh; overflow-y: auto;">
        <h3 style="margin-bottom: 1rem;">Edit Schedule</h3>
        <form id="edit-schedule-form">
            <input type="hidden" id="edit_schedule_id">
            <div class="form-group">
                <label for="edit_train_id">Train</label>
                <select id="edit_train_id" name="train_id" required>
                </select>
            </div>
            <div class="form-group">
                <label for="edit_route_id">Route</label>
                <select id="edit_route_id" name="route_id" required>
                </select>
            </div>
            <div class="form-group">
                <label for="edit_departure_time">Departure Time</label>
                <input type="time" id="edit_departure_time" name="departure_time" required step="1">
            </div>
            <div class="form-group">
                <label for="edit_arrival_time">Arrival Time</label>
                <input type="time" id="edit_arrival_time" name="arrival_time" required step="1">
            </div>
            <div class="form-group">
                <label for="edit_frequency">Frequency</label>
                <select id="edit_frequency" name="frequency" required>
                    <option value="daily">Daily</option>
                    <option value="weekly">Weekly</option>
                    <option value="weekend">Weekend</option>
                </select>
            </div>
            <div class="form-group">
                <label for="edit_base_fare">Base Fare (₴)</label>
                <input type="number" id="edit_base_fare" name="base_fare" required min="1" step="0.01">
            </div>
            <div class="form-group">
                <label for="edit_schedule_status">Status</label>
                <select id="edit_schedule_status" name="status">
                    <option value="active">Active</option>
                    <option value="cancelled">Cancelled</option>
                    <option value="delayed">Delayed</option>
                </select>
            </div>
            <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                <button type="submit" class="btn btn-primary">Save Changes</button>
                <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let allSchedules = [];
let allTrains = [];
let allRoutes = [];

async function loadData() {
    try {
        // Check admin access
        const authData = await apiRequest(API_BASE_URL + '/auth/check');
        if (!authData.authenticated || authData.user.role !== 'admin') {
            showMessage('Admin access required', 'error');
            setTimeout(() => window.location.href = '/', 1000);
            return;
        }

        // Load trains, routes, and schedules in parallel
        const [trainsRes, routesRes, schedulesRes] = await Promise.all([
            fetch(API_BASE_URL + '/trains/').then(r => r.json()),
            fetch(API_BASE_URL + '/routes/').then(r => r.json()),
            fetch(API_BASE_URL + '/schedules/').then(r => r.json())
        ]);

        allTrains = trainsRes.trains || [];
        allRoutes = routesRes.routes || [];
        allSchedules = schedulesRes.schedules || [];

        populateDropdowns();
        renderSchedules();
    } catch (error) {
        console.error('Error loading data:', error);
        showMessage('Error loading data', 'error');
    }
}

function populateDropdowns() {
    // Populate train dropdowns
    const trainOptions = allTrains.map(t => 
        `<option value="${t.id}">${t.train_number} - ${t.train_name}</option>`
    ).join('');
    
    document.getElementById('train_id').innerHTML = '<option value="">Select a train...</option>' + trainOptions;
    document.getElementById('edit_train_id').innerHTML = trainOptions;

    // Populate route dropdowns
    const routeOptions = allRoutes.map(r => 
        `<option value="${r.id}">${r.source_station} → ${r.destination_station} (${r.route_name})</option>`
    ).join('');
    
    document.getElementById('route_id').innerHTML = '<option value="">Select a route...</option>' + routeOptions;
    document.getElementById('edit_route_id').innerHTML = routeOptions;
}

function renderSchedules() {
    const container = document.getElementById('schedules-container');
    
    if (allSchedules.length === 0) {
        container.innerHTML = '<div class="alert alert-info">No schedules found. Add your first schedule above.</div>';
        return;
    }

    let html = `
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Train</th>
                    <th>Route</th>
                    <th>Departure</th>
                    <th>Arrival</th>
                    <th>Frequency</th>
                    <th>Fare (₴)</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
    `;

    allSchedules.forEach(schedule => {
        const statusColors = {
            'active': 'green',
            'cancelled': 'red',
            'delayed': 'orange'
        };
        const statusColor = statusColors[schedule.status] || 'gray';
        
        html += `
            <tr>
                <td>${schedule.id}</td>
                <td><strong>${schedule.train_number || 'N/A'}</strong><br><small>${schedule.train_name || ''}</small></td>
                <td>${schedule.source_station || 'N/A'} → ${schedule.destination_station || 'N/A'}</td>
                <td>${schedule.departure_time || 'N/A'}</td>
                <td>${schedule.arrival_time || 'N/A'}</td>
                <td>${schedule.frequency}</td>
                <td>₴${schedule.base_fare}</td>
                <td style="color: ${statusColor}; font-weight: bold;">${schedule.status.toUpperCase()}</td>
                <td>
                    <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.875rem;" onclick="editSchedule(${schedule.id})">Edit</button>
                    <button class="btn btn-danger" style="padding: 0.25rem 0.5rem; font-size: 0.875rem;" onclick="deleteSchedule(${schedule.id})">Delete</button>
                </td>
            </tr>
        `;
    });

    html += '</tbody></table>';
    container.innerHTML = html;
}

// Format time for API (HH:MM:SS)
function formatTimeForApi(timeValue) {
    if (timeValue.length === 5) {
        return timeValue + ':00';
    }
    return timeValue;
}

// Add new schedule
document.getElementById('add-schedule-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = {
        train_id: parseInt(document.getElementById('train_id').value),
        route_id: parseInt(document.getElementById('route_id').value),
        departure_time: formatTimeForApi(document.getElementById('departure_time').value),
        arrival_time: formatTimeForApi(document.getElementById('arrival_time').value),
        frequency: document.getElementById('frequency').value,
        base_fare: parseFloat(document.getElementById('base_fare').value),
        status: document.getElementById('schedule_status').value
    };

    try {
        const response = await apiRequest(API_BASE_URL + '/schedules/', {
            method: 'POST',
            body: JSON.stringify(formData)
        });

        showMessage('Schedule added successfully!', 'success');
        document.getElementById('add-schedule-form').reset();
        loadData();
    } catch (error) {
        showMessage('Error adding schedule: ' + error.message, 'error');
    }
});

// Edit schedule
function editSchedule(scheduleId) {
    const schedule = allSchedules.find(s => s.id === scheduleId);
    if (!schedule) return;

    document.getElementById('edit_schedule_id').value = schedule.id;
    document.getElementById('edit_train_id').value = schedule.train_id;
    document.getElementById('edit_route_id').value = schedule.route_id;
    document.getElementById('edit_departure_time').value = schedule.departure_time ? schedule.departure_time.substring(0, 5) : '';
    document.getElementById('edit_arrival_time').value = schedule.arrival_time ? schedule.arrival_time.substring(0, 5) : '';
    document.getElementById('edit_frequency').value = schedule.frequency;
    document.getElementById('edit_base_fare').value = schedule.base_fare;
    document.getElementById('edit_schedule_status').value = schedule.status;

    document.getElementById('edit-modal').style.display = 'block';
}

function closeEditModal() {
    document.getElementById('edit-modal').style.display = 'none';
}

document.getElementById('edit-schedule-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const scheduleId = document.getElementById('edit_schedule_id').value;
    const formData = {
        departure_time: formatTimeForApi(document.getElementById('edit_departure_time').value),
        arrival_time: formatTimeForApi(document.getElementById('edit_arrival_time').value),
        frequency: document.getElementById('edit_frequency').value,
        base_fare: parseFloat(document.getElementById('edit_base_fare').value),
        status: document.getElementById('edit_schedule_status').value
    };

    try {
        await apiRequest(API_BASE_URL + '/schedules/' + scheduleId, {
            method: 'PUT',
            body: JSON.stringify(formData)
        });

        showMessage('Schedule updated successfully!', 'success');
        closeEditModal();
        loadData();
    } catch (error) {
        showMessage('Error updating schedule: ' + error.message, 'error');
    }
});

// Delete schedule
async function deleteSchedule(scheduleId) {
    if (!confirm('Are you sure you want to delete this schedule? This will also delete all associated tickets.')) {
        return;
    }

    try {
        await apiRequest(API_BASE_URL + '/schedules/' + scheduleId, {
            method: 'DELETE'
        });

        showMessage('Schedule deleted successfully!', 'success');
        loadData();
    } catch (error) {
        showMessage('Error deleting schedule: ' + error.message, 'error');
    }
}

// Close modal when clicking outside
document.getElementById('edit-modal').addEventListener('click', (e) => {
    if (e.target.id === 'edit-modal') {
        closeEditModal();
    }
});

loadData();
</script>
{% endblock %}
